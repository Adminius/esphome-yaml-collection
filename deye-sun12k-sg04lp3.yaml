# YAML for ESPHome for Deye SUN12k-sg04lp3 inverters
# based on: https://github.com/klatremis/esphome-for-deye
# Use at your own risk!

substitutions:
  name: deye12k                                                      #name in ESPhome
  device_description: "Esphome component for Deye sun-12k-sg04lp3"   #Description in ESPhome
  modbus_controller_id: sg04lp3                                      #name for the modbus controler
  device_type: sun12k                                                #all entities in Home Assistant will start with this text to help identify the entitys 

esphome:
  name: ${name}
  friendly_name: Deye12K

#esp32:
#  board: esp32dev
#  framework:
#    type: arduino

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

# Enable logging
logger:
  level: INFO
  
# Enable Home Assistant API
api:
  encryption:
    key: !secret api_deye_sun12k

ota:
  - platform: esphome
    password: !secret ota_deye_sun12k

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
#  manual_ip:
#    static_ip: 192.168.x.x
#    gateway: 192.168.x.x
#    subnet: 255.255.255.0
  reboot_timeout: 5min

mqtt:
  topic_prefix: deye12k
  discovery: false
  broker: !secret mqtt_broker
  port: !secret mqtt_port
  username: !secret mqtt_user
  password: !secret mqtt_password
  discovery_prefix: !secret mqtt_discovery_prefix

uart:
  id: mod_bus
  tx_pin: 7  #13 TXD / DI  3
  rx_pin: 6  #32 RXD / RO  1
  baud_rate: 9600
  stop_bits: 1
#  debug: # uncomment this to see the raw data in the log - useful if you need to decode a different protocol
#    direction: BOTH
#    dummy_receiver: false
#    after:
#      timeout: 100ms
 
modbus:
  id: modbus1
#  flow_control_pin: 2 #for use when you use a rs485 board without auto flow control. Like the rs485 max board.
 
modbus_controller:
  - id: ${modbus_controller_id}
    address: 0x1
    modbus_id: modbus1
    setup_priority: -10
    update_interval: 10sec
  
switch:
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Power On
    id: Power_On
    register_type: holding
    address: 80
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
  
# Battery type: 0: no battery/lead acid, 1: lithium
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Battery On/Off
    id: Battery_on_off
    register_type: holding
    address: 98
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Solar sell
    id: Solar_sell
    register_type: holding
    address: 145
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 30
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Grid Charge
    id: Grid_Charge
    register_type: holding
    address: 130
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Time of Use 
    id: Time_of_Use
    register_type: holding
    address: 146
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 10
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_1_Grid_Charge
    name: Time 1 Grid Charge
    register_type: holding
    address: 172
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 10
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_2_Grid_Charge
    name: Time 2 Grid Charge
    register_type: holding
    address: 173
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 10
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_3_Grid_Charge
    name: Time 3 Grid Charge
    register_type: holding
    address: 174
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 30
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_4_Grid_Charge
    name: Time 4 Grid Charge
    register_type: holding
    address: 175
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 30
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_5_Grid_Charge
    name: Time 5 Grid Charge
    register_type: holding
    address: 176
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 30
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_6_Grid_Charge
    name: Time 6 Grid Charge
    register_type: holding
    address: 177
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
    skip_updates: 30
 
#binary_sensor:
#   - platform: modbus_controller
#     modbus_controller_id: ${modbus_controller_id}
#     name: AC INV relay # bit 0
#     id: AC_INV_relay
#     register_type: holding
#     address: 552
#     bitmask: 0x1
#     skip_updates: 10
 
#   - platform: modbus_controller
#     modbus_controller_id: ${modbus_controller_id}
#     name: AC Load relay Reserved # bit 1
#     id: AC_Load_relay_Reserved
#     register_type: holding
#     address: 552
#     bitmask: 0x2
#     skip_updates: 10
 
#   - platform: modbus_controller
#     modbus_controller_id: ${modbus_controller_id}
#     name: AC grid relay # bit 2
#     id: AC_grid_relay
#     register_type: holding
#     address: 552
#     bitmask: 0x4
#     skip_updates: 10
 
#   - platform: modbus_controller
#     modbus_controller_id: ${modbus_controller_id}
#     name: AC Generator relay # bit 3
#     id: AC_Generator_relay
#     register_type: holding
#     address: 552
#     bitmask: 0x8
#     skip_updates: 10
 
#   - platform: modbus_controller
#     modbus_controller_id: ${modbus_controller_id}
#     name: Turn off/on status
#     id: Turn_off_on_status
#     register_type: holding
#     address: 551
#     bitmask: 0x1
#     skip_updates: 10
 
text_sensor:
   - platform: modbus_controller
     modbus_controller_id: ${modbus_controller_id}
     skip_updates: 10
     name: Running Status
     id: Running_Status
     bitmask: 0
     register_type: holding
     address: 500
     raw_encode: HEXBYTES
     lambda: |-
       uint16_t value = modbus_controller::word_from_hex_str(x, 0);
       switch (value) {
         case 0: return std::string("standby");
         case 1: return std::string("selfcheck");
         case 2: return std::string("normal");
         case 3: return std::string("alarm");
         case 4: return std::string("fault");
         default: return std::string("----");
       }
       return x;

number:
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Maximum_battery_charge_current
    name: "Maximum battery charge current"
    address: 108
    unit_of_measurement: A
    value_type: U_WORD
#    skip_updates: 10
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Maximum_battery_discharge_current
    name: "Maximum battery discharge current"
    address: 109
    unit_of_measurement: A
    value_type: U_WORD
#    skip_updates: 10

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: max_solar_sell_power
    name: "Max Solar Sell Power"
    unit_of_measurement: W
    address: 143
    value_type: U_WORD
    skip_updates: 30

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ax_solar_power
    name: "Max Solar Power"
    unit_of_measurement: W
    address: 340
    value_type: U_WORD
    skip_updates: 30

sensor:
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Heat sink temperature"
    id: heat_sink_temperature
    register_type: holding
    address: 541
    unit_of_measurement: "°C"
    value_type: S_WORD
    accuracy_decimals: 2
    filters:
      - offset: -1000
      - multiply:  0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Load Frequency"
    id: load_frequency
    register_type: holding
    address: 655
    unit_of_measurement: "Hz"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Inverter Frequency"
    id: inverter_frequency
    register_type: holding
    address: 638
    unit_of_measurement: "Hz"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Power"
    id: PV1_Power
    register_type: holding
    address: 672
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Power"
    id: PV2_Power
    register_type: holding
    address: 673
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: U_WORD
    on_value:
      then:
        - component.update: PV_Power_Total

# Sum of PV1 power & PV2 power
  - platform: template
    name: "PV Power Total"
    id: PV_Power_Total
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    lambda: |-
      return (id(PV1_Power).state + id(PV2_Power).state);

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Voltage"
    id: PV1_Voltage
    register_type: holding
    address: 676
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Voltage"
    id: PV2_Voltage
    register_type: holding
    address: 678
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV1 Current"
    id: PV1_Current
    register_type: holding
    address: 677
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV2 Current"
    id: PV2_Current
    register_type: holding
    address: 679
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Production Today"
    id: Production_Today
    register_type: holding
    address: 529
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD  
    skip_updates: 10

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "PV1 Production Today"
#    id: PV1_Production_Today
#    register_type: holding
#    address: 530
#    unit_of_measurement: "kWh"
#    state_class: "total_increasing"
#    device_class: energy
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1
#    value_type: U_WORD  
#    skip_updates: 10

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "PV2 Production Today"
#    id: PV2_Production_Today
#    register_type: holding
#    address: 531
#    unit_of_measurement: "kWh"
#    state_class: "total_increasing"
#    device_class: energy
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1
#    value_type: U_WORD  
#    skip_updates: 10

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "PV Production Total"
    id: PV_Production_Total
    register_type: holding
    address: 534
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Grid Power Total"
    id: Grid_Power_Total
    register_type: holding
    address: 625
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy Bought Today"
    id: Energy_Bought_Today
    register_type: holding
    address: 520
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy Sold Today"
    id: Energy_Sold_Today
    register_type: holding
    address: 521
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy Bought Total"
    id: Energy_Bought_Total
    register_type: holding
    address: 522
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy Sold Total"
    id: Energy_Sold_Total
    register_type: holding
    address: 524
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller #Total Consumption
    modbus_controller_id: ${modbus_controller_id}
    name: "Total Consumption"
    id: Total_Consumption
    register_type: holding
    address: 527
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 2
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Energy Generation Today"
    id: Energy_generation_today
    register_type: holding
    address: 529
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: S_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Inverter Current L1"
    id: Inverter_Current_L1
    register_type: holding
    address: 630
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Inverter Current L2"
    id: Inverter_Current_L2
    register_type: holding
    address: 631
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Inverter Current L3"
    id: Inverter_Current_L3
    register_type: holding
    address: 632
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Current L1"
    id: Grid_Current_L1
    register_type: holding
    address: 613
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Current L2"
    id: Grid_Current_L2
    register_type: holding
    address: 614
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Current L3"
    id: Grid_Current_L3
    register_type: holding
    address: 615
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Voltage L1"
    id: Grid_Voltage_L1
    register_type: holding
    address: 598
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD     
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Voltage L2"
    id: Grid_Voltage_L2
    register_type: holding
    address: 599
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD     
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Voltage L3"
    id: Grid_Voltage_L3
    register_type: holding
    address: 600
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD  

 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Internal CT L1 Power"
    id: Internal_CT_L1_Power
    register_type: holding
    address: 604
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Internal CT L2 Power"
    id: Internal_CT_L2_Power
    register_type: holding
    address: 605
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Internal CT L3 Power"
    id: Internal_CT_L3_Power
    register_type: holding
    address: 606
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Internal Power Total" 
    id: Internal_Power_Total
    register_type: holding
    address: 607
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Power L1"
    id: Grid_Power_L1
    register_type: holding
    address: 616
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Power L2"
    id: Grid_Power_L2
    register_type: holding
    address: 617
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Grid Power L3"
    id: Grid_Power_L3
    register_type: holding
    address: 618
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD     
 
  - platform: modbus_controller  
    modbus_controller_id: ${modbus_controller_id}
    name: "Grid Power Total"
    id: Grid_power_total
    register_type: holding
    address: 619
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Load Power L1"
    id: Load_Power_L1
    register_type: holding
    address: 650
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Load Power L2"
    id: Load_Power_L2
    register_type: holding
    address: 651
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Load Power L3"
    id: Load_Power_L3
    register_type: holding
    address: 652
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD     
 
  - platform: modbus_controller # Load totalpower
    modbus_controller_id: ${modbus_controller_id}
    name: "Load Power Total" 
    id: Load_power_total
    register_type: holding
    address: 653
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Gen Power L1"
    id: Gen_Power_L1
    register_type: holding
    address: 664
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Gen Power L2"
    id: Gen_Power_L2
    register_type: holding
    address: 665
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 2
    name: "Gen Power L3"
    id: Gen_Power_L3
    register_type: holding
    address: 666
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD     

  - platform: modbus_controller # Load totalpower
    modbus_controller_id: ${modbus_controller_id}
    name: "Gen Power Total" 
    id: Gen_power_total
    register_type: holding
    address: 667
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Warning1"
#    id:  Warning1
#    register_type: holding
#    address: 553
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Warning2"
#    id:  Warning2
#    register_type: holding
#    address: 554
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10
 
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Warning3"
#    id:  Warning3
#    register_type: holding
#    address: 555
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10
 
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Error1"
#    id:  Error1
#    register_type: holding
#    address: 556
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10
 
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Error2"
#    id:  Error2
#    register_type: holding
#    address: 557
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10
 
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Error3"
#    id:  Error3
#    register_type: holding
#    address: 558
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10
 
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Failure status of communication board"
#    id:  Failure_status_of_communication_board
#    register_type: holding
#    address: 548
#    accuracy_decimals: 0
#    value_type: U_WORD
#    skip_updates: 10

  # Battery
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Charge Today"
    id: Battery_Charge_Today
    register_type: holding
    address: 514
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
    skip_updates: 10

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Discharge Today"
    id:  Battery_Discharge_Today
    register_type: holding
    address: 515
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD 
    filters:
      - multiply: 0.1
    skip_updates: 10

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Charge Total"
    id: Battery_Charge_Total
    register_type: holding
    address: 516
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Discharge Total"
    id:  Battery_Discharge_Total
    register_type: holding
    address: 518
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R 
    filters:
      - multiply: 0.1
    skip_updates: 10
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Temperature"
    id:  Battery_Temperature
    register_type: holding
    address: 586
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    value_type: U_WORD 
    filters:
      - offset: -1000
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Voltage"
    id: Battery_Voltage
    register_type: holding
    address: 587  
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery SoC"
    id: Battery_SoC
    register_type: holding
    address: 588
    device_class: battery
    unit_of_measurement: "%"
    state_class: "measurement"
    accuracy_decimals: 1
    value_type: U_WORD

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    skip_updates: 2
#    name: "Battery SoH"
#    id: Battery_SoH
#    register_type: holding
#    address: 224
#    unit_of_measurement: "%"
#    state_class: "measurement"
#    accuracy_decimals: 1
#    value_type: U_WORD
#    skip_updates: 30

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery Power"
    id: Battery_power
    register_type: holding
    address: 590
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD 
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery current"
    id: Battery_current
    register_type: holding
    address: 591
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: S_WORD

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Battery corrected Ah"
#    id: Battery_corrected_Ah
#    register_type: holding
#    address: 592
#    unit_of_measurement: "Ah"
#    state_class: "measurement"
#    accuracy_decimals: 0
#    value_type: S_WORD 
#    skip_updates: 10

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Lithium battery alarm position"
#    id: Lithium_battery_alarm_position
#    register_type: holding
#    address: 220
#    state_class: "measurement"
#    accuracy_decimals: 0
#    value_type: S_WORD 
#    skip_updates: 10

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Lithium battery fault location"
#    id: Lithium_battery_fault_location
#    register_type: holding
#    address: 221
#    state_class: "measurement"
#    accuracy_decimals: 0
#    value_type: S_WORD 
#    skip_updates: 10

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery charge current limit"
    id: Battery_charge_current_limit
    register_type: holding
    address: 212
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD 
#    skip_updates: 10

  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "Battery discharge current limit"
    id: Battery_discharge_current_limit
    register_type: holding
    address: 213
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD 
#    skip_updates: 10

# Test Battery
#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Pack 1 Voltage"
#    id: pack_1_voltage
#    register_type: read
#    address: 10040
#    unit_of_measurement: "V"
#    state_class: "measurement"
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01
#    value_type: U_WORD

#  - platform: modbus_controller
#    modbus_controller_id: ${modbus_controller_id}
#    name: "Pack 1 Cell Min V"
#    id: pack_1_cell_min_v
#    register_type: holding
#    address: 10055
#    unit_of_measurement: "V"
#    state_class: "measurement"
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01
#    value_type: U_WORD

select:
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: Energy priority
    address: 141
    value_type: U_WORD
    optionsmap:
      "Battery first": 0
      "Load first": 1
    skip_updates: 30

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: "Limit control mode"
    address: 142
    value_type: U_WORD
    optionsmap:
      "Selling first": 0
      "Zero export to load": 1
      "Zero export to CT": 2
#    skip_updates: 30

# Time of use selectable:

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_1
    name: "Time 1 start"
    address: 148
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300


  
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_2
    name: "Time 2 start"
    address: 149
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_3
    name: "Time 3 start"
    address: 150
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_4
    name: "Time 4 start"
    address: 151
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_5
    name: "Time 5 start"
    address: 152
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_6
    name: "Time 6 start"
    address: 153
    value_type: U_WORD
    optionsmap:
      "00:00": 0
      "01:00": 100
      "02:00": 200
      "03:00": 300
      "04:00": 400
      "05:00": 500
      "06:00": 600
      "07:00": 700
      "08:00": 800
      "09:00": 900
      "10:00": 1000
      "11:00": 1100
      "12:00": 1200
      "13:00": 1300
      "14:00": 1400
      "15:00": 1500
      "16:00": 1600
      "17:00": 1700
      "18:00": 1800
      "19:00": 1900
      "20:00": 2000
      "21:00": 2100
      "22:00": 2200
      "23:00": 2300


  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_1_power
    name: "Time 1 Power"
    address: 154
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_2_power
    name: "Time 2 power"
    address: 155
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_3_power
    name: "Time 3 power"
    address: 156
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_4_power
    name: "Time 4 power"
    address: 157
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_5_power
    name: "Time 5 power"
    address: 158
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_6_power
    name: "Time 6 power"
    address: 159
    value_type: U_WORD
    optionsmap:
      "1kW": 1000
      "2kW": 2000
      "3kW": 3000
      "4kW": 4000
      "5kW": 5000
      "6kW": 6000
      "7kW": 7000
      "8kW": 8000
      "9kW": 9000
      "10kW": 10000
      "11kW": 11000
      "12kW": 12000


  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_1_SoC
    name: "Time 1 SoC"
    address: 166
    value_type: U_WORD
    optionsmap:
      "5%": 5  
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_2_SoC
    name: "Time 2 SoC"
    address: 167
    value_type: U_WORD
    optionsmap:
      "5%": 5  
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_3_capacity
    name: "Time 3 SoC"
    address: 168
    value_type: U_WORD
    optionsmap:
      "5%": 5  
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_4_SoC
    name: "Time 4 Soc"
    address: 169
    value_type: U_WORD
    optionsmap:
      "5%": 5  
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100

    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_5_SoC
    name: "Time 5 SoC"
    address: 170
    value_type: U_WORD
    optionsmap: 
      "5%": 5 
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Time_6_SoC
    name: "Time 6 SoC"
    address: 171
    value_type: U_WORD
    optionsmap: 
      "5%": 5 
      "10%": 10
      "15%": 15
      "20%": 20
      "30%": 30
      "40%": 40
      "50%": 50
      "60%": 60
      "70%": 70
      "80%": 80
      "90%": 90
      "100%": 100

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Maximum_battery_grid_charge_power
    name: Maximum battery grid charge power"
    address: 128
    value_type: U_WORD
    optionsmap:
      "0W": 0
      "250W": 5
      "500W": 10
      "1kW": 20
      "2kW": 40
      "3kW": 60
      "4kW": 80
      "5kW": 100
      "6kW": 120
      "7kW": 140
      "8kW": 160
      "9kW": 180
      "10kW": 200
      "11kW": 220
      "12kW": 240

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: battery_mode
    name: "Battery Mode"
    address: 111
    value_type: U_WORD
    optionsmap:
      "No Battery": 2
      "Voltage": 0 
      "Percentage": 1

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: Gen_Port_Mode
    name: "Gen Port Mode"
    address: 133
    value_type: U_WORD
    optionsmap:
      "Generator": 0
      "Smartload": 1
      "Micro Inverter": 2